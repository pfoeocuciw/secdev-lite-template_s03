# S04 — STRIDE per element Matrix

| Element                    | Data / Boundary                    | Threat (S/T/R/I/D/E) | Description                                                                                                                                     | NFR link (ID)                     | Mitigation idea (ADR later)              |
|----------------------------|-------------------------------------|----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|------------------------------------------|
| Edge: Client → API         | JWT / Public                        | S                    | Подмена или повтор использования украденного/истёкшего JWT                                                                                      | NFR-SEC-AUTHN, NFR-RATELIMIT       | JWT TTL+Refresh; Rate limit на /auth/*   |
| Edge: Client → API         | Input / Query                       | T                    | Манипуляции параметрами запроса поиска или заказа (SQLi, фильтры, path tampering)                                                               | NFR-INPUT-VALIDATION, NFR-API      | Centralized validation; strict schema   |
| Edge: Client → API         | HTTP requests                       | R                    | Отсутствие корректной корреляции и логирования → невозможность отследить действия пользователей                                                 | NFR-OBSERVABILITY, NFR-AUDIT       | Correlation IDs; Structured logs        |
| Node: API                  | Internal                            | I                    | Логирование чувствительных данных (PII, токены) в ответах или логах                                                                             | NFR-PRIVACY-PII, NFR-API-ERRORS    | Маскирование PII; RFC7807 без стэктрейсов |
| Node: API                  | Internal                            | D                    | Перегрузка публичных эндпоинтов (поиск, заказ) через массовые/тяжёлые запросы                                                                   | NFR-LIMITS, NFR-RATELIMIT         | Rate limiting; Query length limits     |
| Node: API                  | Internal                            | E                    | Пробелы в проверке tenant-id или ролей → возможность действий от имени других пользователей                                                      | NFR-SEC-AUTHZ                     | Tenant scoping + RBAC                  |
| Edge: API → SearchSvc      | DTO (SearchRequest)                 | T                    | Подмена фильтров или специальных символов в поиске для обхода логики / DoS                                                                      | NFR-INPUT-VALIDATION, NFR-PERF     | Query sanitizer; Validation            |
| Node: SearchSvc            | SearchIndex                         | D                    | Отсутствие ограничений на сложность запроса → деградация поисковой подсистемы                                                                   | NFR-LIMITS, NFR-PERF              | Timeout; Query complexity guard       |
| Edge: API → OrdersSvc      | DTO (Cart/OrderCreate + PII)        | T                    | Подмена tenant-id или полей заказа при передаче внутрь сервиса                                                                                  | NFR-SEC-AUTHZ, NFR-INPUT-VALIDATION | Strict DTO validation; Tenant scoping |
| Edge: API → OrdersSvc      | DTO (Cart/OrderCreate + PII)        | I                    | Передача и хранение PII без шифрования или маскирования                                                                                         | NFR-PRIVACY-PII, NFR-ENCRYPTION   | PII Encryption + Masking              |
| Node: OrdersSvc           | SQL                                | R                    | Отсутствие аудита по операциям с заказами (создание/отмена)                                                                                    | NFR-AUDITABILITY                  | Audit trail; Event sourcing           |
| Node: OrdersSvc           | SQL / Business logic               | E                    | Ошибки в проверках прав/тенанта → возможность менять чужие заказы                                                                              | NFR-SEC-AUTHZ                     | RBAC + tenant isolation              |
| Edge: PaySvc → PayProvider | HTTPS / payment-init                | D                    | Отсутствие таймаутов/ретраев/CB → зависания сервиса при сбое внешнего провайдера                                                                 | NFR-TIMEOUTS, NFR-CB              | Timeout ≤2s, retry ≤3, CircuitBreaker |
| Edge: PayProvider → API   | HTTPS / webhook                     | S                    | Отсутствие проверки HMAC подписи или Replay Protection → возможность подделать уведомления                                                      | NFR-WEBHOOK-AUTH, NFR-REPLAY      | HMAC validation; Timestamp+Nonce     |
| Edge: PayProvider → API   | HTTPS / webhook                     | T                    | Изменение статуса платежа через поддельный webhook                                                                                              | NFR-WEBHOOK-AUTH                 | Signature validation; strict schema  |
| Edge: PayProvider → API   | HTTPS / webhook                     | R                    | Нет аудита обработки webhook → невозможно отследить фейковые статусы                                                                           | NFR-AUDITABILITY                  | Webhook logs + correlation IDs       |
| Node: PaySvc              | SQL                                | I                    | Хранение платежных данных без шифрования                                                                                                        | NFR-PRIVACY-PII, NFR-ENCRYPTION   | Encryption at rest + masking         |
| Node: PaySvc              | SQL / internal                     | E                    | Возможность изменить статус платежа в обход бизнес-логики                                                                                      | NFR-SEC-AUTHZ                     | Business rule enforcement + RBAC    |
| Edge: Q → Email          | Events                             | D                    | Потеря или дублирование сообщений в очереди приводит к сбоям уведомлений                                                                       | NFR-RELIABILITY                   | DLQ + retry + idempotent handlers   |
